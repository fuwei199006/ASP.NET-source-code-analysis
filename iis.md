### 服务器的监听(IIS6.0+版本)     

1. 当请求到达服务器时，请求最终会到达TCPIP.SYS驱动程序，TCPIP.SYS将请求转发给HTTP.SYS网络驱动程序的请求队列中（可以理解为专门处理http请求的进程），当然在处理请求的过程中，HTTP.SYS进程会维护一个配置表用缓存请求的url和和应用程序池对应的关系。   

2. 当一个http请求被捕获到，HTTP.SYS会读取配置表，如果对应的应用程序没有启动，则HTTP.SYS会启动IIS相对应的应用程序。具体运行机制可以理解成为：   
 
 ![Http.SYS机制](/assets/HttpSys机制.png)


### HTTP.SYS     
HTTP.SYS是TCP之上的一个网络驱动程序，因此，HTTP.SYS不再属于IIS(这里说的IIS都是IIS6.0+版本，下文如果不特殊指明，默认为IIS6.0+版本)，它已经从IIS中独立了出来。 Http.Sys独立有以下几个优点：     

- 可靠性： HTTP.SYS运行在内核模式下，作为操作系统的驱动程序运行。因此，HTTP.SYS不会受到用户代码的影响，它始终处于稳定运行状态，对用户的http请求进行监听，并及时作出反应。   

- 高性能： 从用户发送http请求到系统返回响应结果的这一过程都是HTTP.SYS在内核模式下完成的。不需要在内核模式和用户模式下进行切换，这样就极大地节省了系统资源，提高了请求的响应速度。 
 

### IIS处理    

#### W3SVC

1. W3SVC服务是一个独立运行的程序，寄宿在svchost.exe进程中，负责用户的参数监视和重新启动应用池的工作。 当一个请求进入HTTP.SYS的队列中，会通知W3SVC服务根据IIS中的配置去创建对应的应用进程，进行处理。       


####  W3WP.exe   

1. 当HTTP.SYS把请求传递给IIS时候，W3SVC会启动对应的应用程序池 
   
2. 当用户请求的是静态文件，如：HTML和图片等，IIS会直接读取文件内容，转成二进制文件流，返回给HTTP.SYS。    
      
3. 当请求非静态文件，如：.aspx。    
  
  a. w3wp.exe会根据IIS中ISAPI扩展读取对应的处理的Dll，用asp.net举例：当用户访问的网站是asp.net平台，则 类型是.cshtml和.aspx文件类型。根据配置w3wp.exe会加载aspnet_isapi.dll(简称是ISAPI).     
   
   IIS中应用程序的映射：     
   
  ![](/assets/IIS处理请求映射.png)
  
  IIS中处理流程：
  
  ![](/assets/IIS处理流程.png)
  
  b.  当ISAPI加载后，会启动一个ASP.NET的工作进程，把信息的控制权交给Asp.Net来处理。此处请求的处理由IIS交给了asp.net的程序。  
  
  基于对上面的说明，可以把IIS的处理过程理解表示如下图：       
  
  ![](/assets/w3wp处理.png)      
  
  
  说到这里，把IIS请求的流程简单的做了说明，后面的工作就由Asp.Net去完成了。
  
### .Net程序的运行过程     

说到Asp.Net的运行，不得不先说下.Net的运行机制（算是为后面的文章做一个铺垫）。

在vs中写了一段C#代码(或者其它.net平台的语言，此处简单的用C#来说明) ，编译器会把代码转译成IL的中间语言程序。当程序运行时，系统调用jit编译器，把中间语言编译成对应的cpu指令，等待cpu的最终调用。具体过程如下：
    
![](/assets/C#代码运行过程.png)   


### 托管和非托管   



  
  




  

